<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TeraBox Video Player</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.1/dist/hls.min.js"></script>
<style>
body { font-family: Arial; max-width: 800px; margin: auto; padding: 20px; }
#video-container { margin-top: 20px; }
.error-message { color: red; margin-top: 20px; }
.spinner-container { display: flex; justify-content: center; margin-top: 20px; }
.spinner4 { width: 40px; height: 40px; border: 5px solid #ccc; border-top: 5px solid #333; border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body>

<h1>TeraBox Video Player</h1>
<input type="text" id="terabox-link" placeholder="Paste TeraBox Link Here" style="width:100%; padding:10px;">
<button id="play-btn" style="margin-top:10px; padding:10px;">Play Video</button>

<div id="video-container"></div>
<div id="file-info"></div>
<div id="loading"></div>

<script>
const api = "https://api.iteraplay.com";

// Show loading spinner
function showLoading(active) {
    const el = document.getElementById('loading');
    if(active) el.innerHTML = '<div class="spinner-container"><div class="spinner4"></div></div>';
    else el.innerHTML = '';
}

// Display error
function showError(msg) {
    const container = document.getElementById('video-container');
    container.innerHTML = `<div class="error-message">${msg}</div>`;
}

// Play video using HLS.js or native support
function playVideo(stream_url, fileName) {
    showLoading(false);
    const container = document.getElementById('video-container');
    container.innerHTML = '';
    const video = document.createElement('video');
    video.controls = true;
    video.autoplay = true;
    video.muted = true;
    video.preload = 'metadata';
    container.appendChild(video);

    document.title = fileName;
    document.getElementById('file-info').textContent = fileName;

    if(Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(stream_url);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, () => video.play().catch(()=> video.muted=false));
        hls.on(Hls.Events.ERROR, (event,data) => {
            if(data.fatal){ showError("Failed to load video stream."); hls.destroy(); }
        });
    } else if(video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = stream_url;
        video.addEventListener('loadedmetadata', ()=> video.play().catch(()=> video.muted=false));
    } else {
        video.src = stream_url;
    }
}

// Fetch TeraBox files via API
async function fetchTeraBoxFiles(url) {
    showLoading(true);
    try {
        const res = await fetch(api, {
            method: 'POST',
            headers: { 'Content-Type':'application/json', 'X-API-Key':'terabox_pro_api_2025_premium' },
            body: JSON.stringify({ link: url })
        });
        const data = await res.json();
        if(data.status==='success' && data.list && data.list.length>0){
            return data.list;
        } else {
            throw new Error('No videos found in this link.');
        }
    } catch(e) {
        showLoading(false);
        showError('Failed to fetch TeraBox files.');
        console.error(e);
        return [];
    }
}

// Recursive search for first video
function findFirstVideo(files){
    for(const item of files){
        if(item.type==='video' && (item.stream_url || item.fast_stream_url)) return item;
        if(item.is_dir===1 && item.list) {
            const found = findFirstVideo(item.list);
            if(found) return found;
        }
    }
    return null;
}

// Main function
document.getElementById('play-btn').addEventListener('click', async ()=>{
    const link = document.getElementById('terabox-link').value.trim();
    if(!link) { showError('Please paste a TeraBox link'); return; }
    const files = await fetchTeraBoxFiles(link);
    const video = findFirstVideo(files);
    if(video){
        const stream_url = video.fast_stream_url || video.stream_url;
        playVideo(stream_url, video.name);
    } else {
        showError('No playable video found in this link.');
    }
});
</script>
</body>
</html>
